<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />

    <!-- Essential viewport meta tag -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Browser compatibility -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <!-- PWA / Mobile -->
    <meta name="mobile-web-app-capable" content="yes" />
    <meta
      name="description"
      content="AI Application with full-stack capabilities"
    />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />

    <title>Loan Applications History</title>

    <style>
      table {
        border-collapse: collapse;
        width: 100%;
      }
      th,
      td {
        border: 1px solid #ccc;
        padding: 8px;
        text-align: center;
      }
      th {
        background: #f2f2f2;
      }
    </style>
  </head>

  <body>
    <h2>ðŸ“‹ Loan Applications (Admin Panel)</h2>

    <button
      onclick="clearApplications()"
      style="background: red; color: white; padding: 8px"
    >
      ðŸ—‘ Clear All Applications
    </button>
    <br /><br />

    <button onclick="logout()">ðŸšª Logout</button><br />
    <button onclick="downloadCSV()">â¬‡ Download CSV</button>
    <br /><br />
    <h3>ðŸ“Š Dashboard</h3>
    <p>Total Applications: <b id="total"></b></p>
    <p>Average Loan Amount: <b id="avgLoan"></b></p>

    <canvas id="decisionChart" width="200" height="100"></canvas>
    <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>

    <br /><br />
    <table>
      <thead>
        <tr>
          <th>Income</th>
          <th>Age</th>
          <th>Loan</th>
          <th>Credit_Score</th>
          <th>Decision</th>
          <th>Reason</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>

    <script>
      const API_BASE = "https://ai-loan-prediction-a3gd.onrender.com";
      const token = localStorage.getItem("token");

      if (!token) {
        alert("Please login again");
        window.location.href = "login.html";
      }

      // ---- LOAD TABLE ----
      fetch(`${API_BASE}/applications`, {
        headers: { Authorization: token },
      })
        .then((res) => {
          if (!res.ok) throw new Error("Unauthorized");
          return res.json();
        })
        .then((data) => {
          const body = document.getElementById("tableBody");
          body.innerHTML = "";
          data.forEach((app) => {
            body.innerHTML += `
      <tr>
        <td>${app.income}</td>
        <td>${app.age}</td>
        <td>${app.loan_amount}</td>
        <td>${app.credit_score}</td>
        <td>${app.decision}</td>
        <td>${app.reason}</td>
      </tr>`;
          });
        });

      // ---- DASHBOARD ----
      fetch(`${API_BASE}/stats`, {
        headers: { Authorization: token },
      })
        .then((res) => {
          if (!res.ok) throw new Error("Unauthorized");
          return res.json();
        })
        .then((data) => {
          document.getElementById("total").innerText = data.total_applications;
          document.getElementById("avgLoan").innerText = data.average_loan;

          new Chart(document.getElementById("decisionChart"), {
            type: "bar",
            data: {
              labels: Object.keys(data.decisions),
              datasets: [
                {
                  label: "Loan Decisions",
                  data: Object.values(data.decisions),
                },
              ],
            },
          });
        })
        .catch(() => {
          console.warn("Dashboard not loaded (unauthorized)");
        });

      // ---- CSV ----
      function downloadCSV() {
        fetch(`${API_BASE}/export`, {
          headers: { Authorization: token },
        })
          .then((res) => res.blob())
          .then((blob) => {
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = "loans.csv";
            a.click();
          });
      }

      function clearApplications() {
        if (!confirm("Are you sure you want to delete ALL applications?"))
          return;

        const token = localStorage.getItem("token");

        fetch(`${API_BASE}/clear`, {
          method: "POST",
          headers: {
            Authorization: token,
          },
        })
          .then((res) => {
            if (!res.ok) throw new Error("Unauthorized");
            return res.json();
          })
          .then(() => {
            alert("All applications cleared");
            location.reload();
          })
          .catch(() => {
            alert("Session expired. Please login again.");
            localStorage.removeItem("token");
            window.location.href = "login.html";
          });
      }
      function logout() {
        localStorage.removeItem("token");
        alert("Logged out successfully");
        window.location.href = "login.html";
      }
    </script>
  </body>
</html>
