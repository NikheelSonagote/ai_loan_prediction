<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />

    <!-- Essential viewport meta tag -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Browser compatibility -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <!-- PWA / Mobile -->
    <meta name="mobile-web-app-capable" content="yes" />
    <meta
      name="description"
      content="AI Application with full-stack capabilities"
    />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />

    <title>Loan Applications History</title>

    <style>
      table {
        border-collapse: collapse;
        width: 100%;
      }
      th,
      td {
        border: 1px solid #ccc;
        padding: 8px;
        text-align: center;
      }
      th {
        background: #f2f2f2;
      }
    </style>
  </head>

  <body>
    <h2>ðŸ“‹ Loan Applications (Admin Panel)</h2>

    <button onclick="clearData()">Clear All Applications</button><br /><br />
    <button onclick="logout()">ðŸšª Logout</button><br />
    <button onclick="downloadCSV()">â¬‡ Download CSV</button>
    <br /><br />
    <h3>ðŸ“Š Dashboard</h3>
    <p>Total Applications: <b id="total"></b></p>
    <p>Average Loan Amount: <b id="avgLoan"></b></p>

    <canvas id="decisionChart" width="400" height="200"></canvas>
    <script src="chart.min.js"></script>

    <br /><br />
    <table>
      <thead>
        <tr>
          <th>Income</th>
          <th>Age</th>
          <th>Loan</th>
          <th>Credit_Score</th>
          <th>Decision</th>
          <th>Reason</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>

    <script>
      const API_BASE = "https://ai-loan-prediction-a3gd.onrender.com";

      fetch(`${API_BASE}/applications`, {
        credentials: "include", // ðŸ‘ˆ send session cookie
      })
        .then((res) => {
          // ðŸ”’ Handle unauthorized access FIRST
          if (res.status === 401 || res.status === 403) {
            alert("Session expired. Please login again.");
            window.location.href = "login.html";
            throw new Error("Unauthorized");
          }

          // ðŸ”´ Handle missing route
          if (!res.ok) {
            throw new Error("Server error");
          }

          return res.json();
        })
        .then((data) => {
          const body = document.getElementById("tableBody");
          body.innerHTML = "";

          data.forEach((app) => {
            const row = document.createElement("tr");
            row.innerHTML = `
            <td>${app.income}</td>
            <td>${app.age}</td>
            <td>${app.loan_amount}</td>
            <td>${app.credit_score}</td>
            <td style="color:${app.decision === "Approved" ? "green" : "red"}">
                ${app.decision}
            </td>
            <td>${app.reason}</td>
        `;
            body.appendChild(row);
          });
        })
        .catch((err) => console.log("Fetch stopped:", err.message));

      function clearData() {
        if (!confirm("Are you sure you want to clear all applications?"))
          return;

        fetch(`${API_BASE}/clear`, {
          method: "POST",
          credentials: "include",
        })
          .then((res) => {
            if (!res.ok) throw new Error("Failed to clear data");
            return res.json();
          })
          .then(() => {
            alert("All applications cleared");
            location.reload();
          })
          .catch((err) => alert(err.message));
      }

      function logout() {
        fetch(`${API_BASE}/logout`, {
          method: "POST",
          credentials: "include",
        }).then(() => {
          window.location.href = "login.html";
        });
      }

      function downloadCSV() {
        fetch(`${API_BASE}/export`, {
          credentials: "include",
        })
          .then((res) => res.blob())
          .then((blob) => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "loan_applications.csv";
            a.click();
            window.URL.revokeObjectURL(url);
          });
      }

      const token = localStorage.getItem("token");

      fetch(`${API_BASE}/stats`, {
        headers: {
          Authorization: token,
        },
      })
        .then((res) => {
          if (!res.ok) throw new Error("Unauthorized");
          return res.json();
        })
        .then((data) => {
          document.getElementById("total").innerText = data.total_applications;
          document.getElementById("avgLoan").innerText = data.average_loan;

          new Chart(document.getElementById("decisionChart"), {
            type: "bar",
            data: {
              labels: Object.keys(data.decisions),
              datasets: [
                {
                  label: "Loan Decisions",
                  data: Object.values(data.decisions),
                },
              ],
            },
          });
        });
    </script>
  </body>
</html>
